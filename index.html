<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Monitoring Kualitas Udara RS</title>
<style>
body {font-family: Arial; background:#f0f8ff; margin:0; padding:0;}
header {background:#2c3e50; color:white; padding:15px; text-align:center;}
.container {max-width:900px; margin:20px auto; padding:10px;}
.card {background:white; border-radius:10px; box-shadow:0 3px 10px rgba(0,0,0,0.1); padding:20px; margin-bottom:20px;}
.progress-container {background:#eee; border-radius:10px; height:25px; position:relative; margin:10px 0;}
.progress-bar {height:100%; width:0%; background:#4caf50; border-radius:10px; transition:0.3s;}
.threshold-line {position:absolute; width:3px; height:100%; background:#000; top:0; left:0;}
button {padding:10px 15px; margin-right:10px; cursor:pointer;}
button.on{background:#4caf50;color:white;} button.off{background:#f44336;color:white;}
</style>
</head>
<body>

<header>
<h1>RS Sejahtera - Monitoring Asap</h1>
<p>Unit Keamanan Rumah Sakit</p>
</header>

<div class="container">
<div class="card">
<h2>Status Sensor</h2>
<p>Nilai Sensor: <span id="sensorValue">0</span></p>
<div class="progress-container">
    <div class="progress-bar" id="progressBar"></div>
    <div class="threshold-line" id="thresholdLine"></div>
</div>
<p>Status: <span id="statusText">AMAN</span></p>
<p>Buzzer: <span id="buzzerText">OFF</span></p>
</div>

<div class="card">
<h2>Kontrol</h2>
<label>Threshold: <span id="thresholdValue">2500</span></label><br>
<input type="range" min="500" max="4000" value="2500" id="thresholdSlider" style="width:100%; margin:10px 0;">
<button class="on" onclick="buzzerManual('on')">Buzzer ON</button>
<button class="off" onclick="buzzerManual('off')">Buzzer OFF</button>
<button class="on" onclick="saveThreshold()">Simpan Threshold</button>
</div>

<div class="card">
<h2>Info</h2>
<p>Terakhir Update: <span id="lastUpdate">-</span></p>
<p>Status Koneksi: <span id="connStatus">üì∂</span></p>
</div>
</div>

<script>
const sensorValue = document.getElementById("sensorValue");
const statusText = document.getElementById("statusText");
const buzzerText = document.getElementById("buzzerText");
const progressBar = document.getElementById("progressBar");
const thresholdLine = document.getElementById("thresholdLine");
const thresholdSlider = document.getElementById("thresholdSlider");
const thresholdValue = document.getElementById("thresholdValue");
const lastUpdate = document.getElementById("lastUpdate");

thresholdSlider.addEventListener('input', ()=>thresholdValue.textContent = thresholdSlider.value);

async function fetchSensor(){
    try{
        const res = await fetch("/api/sensor");
        const data = await res.json();
        sensorValue.textContent = data.value;
        buzzerText.textContent = data.buzzer_active?"AKTIF":"OFF";

        const prog = (data.value/4095)*100;
        progressBar.style.width = prog+"%";
        thresholdLine.style.left = (data.threshold/4095)*100+"%";

        if(data.value > data.threshold){
            statusText.textContent="BAHAYA!";
            statusText.style.color="#f44336"; progressBar.style.background="#f44336";
        }else if(data.value>data.threshold*0.7){
            statusText.textContent="WASPADA";
            statusText.style.color="#ff9800"; progressBar.style.background="#ff9800";
        }else{
            statusText.textContent="AMAN";
            statusText.style.color="#4caf50"; progressBar.style.background="#4caf50";
        }
        lastUpdate.textContent = new Date().toLocaleTimeString("id-ID");
        document.getElementById("connStatus").textContent="üì∂ Terhubung";
        document.getElementById("connStatus").style.color="#4caf50";
    }catch(e){
        document.getElementById("connStatus").textContent="‚ùå Terputus";
        document.getElementById("connStatus").style.color="#f44336";
    }
}

setInterval(fetchSensor, 1000);

async function buzzerManual(action){
    await fetch("/api/buzzer", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({action})
    });
    fetchSensor();
}

async function saveThreshold(){
    const thr = parseInt(thresholdSlider.value);
    await fetch("/api/threshold", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({threshold:thr})
    });
}
</script>

</body>
</html>
